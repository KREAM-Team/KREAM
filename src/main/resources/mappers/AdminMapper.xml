<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kream.kream.mappers.AdminMapper">

    <select id="selectUser"
            resultType="com.kream.kream.entities.UserEntity">
        SELECT `id`               AS `id`,
               `email`            AS `email`,
               `password`         AS `password`,
               `contact`          AS `contact`,
               `nickname`         AS `nickname`,
               `is_admin`         AS `isAdmin`,
               `is_suspended`     AS `isSuspended`,
               `is_verified`      AS `isVerified`,
               `social_type_code` AS `socialTypeCode`,
               `social_id`        AS `socialId`,
               `created_at`       AS `createdAt`,
               `updated_at`       AS `updatedAt`,
               `deleted_at`       AS `deletedAt`
        FROM `kream`.`user`
        WHERE `deleted_at` IS NULL
            AND `is_verified` = true
        ORDER BY `id` DESC
    </select>

    <select id="selectUserBySearch"
            resultType="com.kream.kream.entities.UserEntity">
        SELECT `id`               AS `id`,
               `email`            AS `email`,
               `password`         AS `password`,
               `contact`          AS `contact`,
               `nickname`         AS `nickname`,
               `is_admin`         AS `isAdmin`,
               `is_suspended`     AS `isSuspended`,
               `is_verified`      AS `isVerified`,
               `social_type_code` AS `socialTypeCode`,
               `social_id`        AS `socialId`,
               `created_at`       AS `createdAt`,
               `updated_at`       AS `updatedAt`,
               `deleted_at`       AS `deletedAt`
        FROM `kream`.`user`
        WHERE `deleted_at` IS NULL
            AND `is_verified` = true
        <if test="filter.equals('all')">
            AND (`email` LIKE CONCAT('%', #{keyword}, '%') OR `nickname` LIKE CONCAT('%', #{keyword}, '%') OR `contact` LIKE CONCAT('%', #{keyword}, '%') OR `social_type_code` LIKE CONCAT('%', #{keyword}, '%'))
            <if test="keyword.equals('정지')">
                OR is_suspended = true
            </if>
            <if test="keyword.equals('활동')">
                OR is_suspended = false
            </if>
        </if>
        <if test="filter.equals('email')">
            AND `email` LIKE CONCAT('%', #{keyword}, '%')
        </if>
        <if test="filter.equals('nickname')">
            AND (`nickname` LIKE CONCAT('%', #{keyword}, '%') OR `product_name_en` LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="filter.equals('suspended')">
            <if test="keyword.equals('정지')">
                AND is_suspended = true
            </if>
            <if test="keyword.equals('활동')">
                AND is_suspended = false
            </if>
        </if>
        ORDER BY `id` DESC
    </select>

    <insert id="insertProduct"
            useGeneratedKeys="true"
            keyColumn="id"
            keyProperty="id"
            parameterType="com.kream.kream.entities.ProductEntity">
        INSERT INTO `kream`.`product` (`id`, `category_detail_id`, `product_name_ko`, `product_name_en`, `model_number`, `release_date`, `color`,
                                           `brand`, `category`, `gender`, `created_at`, `updated_at`, `is_deleted`)
        VALUES (#{id}, #{categoryDetailId}, #{productNameKo}, #{productNameEn}, #{modelNumber}, #{releaseDate}, #{color}, #{brand}, #{category}, #{gender}, #{createdAt}, #{updatedAt}, #{isDeleted})
    </insert>

    <select id="selectByCategoryId"
            resultType="com.kream.kream.entities.CategoryDetailEntity">
        SELECT *
        FROM `kream`.`category_detail`
        WHERE `type` = #{categoryDetailType}
        LIMIT 1
    </select>

    <insert id="insertImage"
            useGeneratedKeys="true"
            keyColumn="id"
            keyProperty="id"
            parameterType="com.kream.kream.entities.ImageEntity">
        INSERT INTO `kream`.`image` (`id`, `product_id`, `data`, `type`, `name`, `is_primary`, `created_at`)
        VALUES (#{id}, #{productId}, #{data}, #{type}, #{name}, #{isPrimary}, #{createdAt})
    </insert>

    <select id="selectImageByProductIdAndIsPrimary"
            resultType="com.kream.kream.entities.ImageEntity">
        SELECT `id`         AS `id`,
               `product_id` AS `productId`,
               `data`       AS `data`,
               `type`       AS `type`,
               `name`       AS `name`,
               `is_primary` AS `isPrimary`,
               `created_at` AS `createdAt`
        FROM `kream`.`image`
        WHERE `product_id` = #{id} AND `is_primary` = true
        LIMIT 1
    </select>

    <select id="selectProduct"
            resultType="com.kream.kream.entities.ProductEntity">
        SELECT `product`.`id`         AS `id`,
               `category_detail_id`   AS `categoryDetailId`,
               `product_name_ko`      AS `productNameKo`,
               `product_name_en`      AS `productNameEn`,
               `model_number`         AS `modelNumber`,
               `release_date`         AS `releaseDate`,
               `color`                AS `color`,
               `brand`                AS `brand`,
               `category`             AS `category`,
               `gender`               AS `gender`,
               `product`.`created_at` AS `createdAt`,
               `updated_at`           AS `updatedAt`,
               `is_deleted`           AS `isDeleted`
        FROM `kream`.`product`
        WHERE is_deleted = FALSE
        ORDER BY `id` DESC
    </select>

    <select id="selectProductById"
            resultType="com.kream.kream.entities.ProductEntity">
        SELECT `id`                 AS `id`,
               `category_detail_id` AS `categoryDetailId`,
               `product_name_ko`    AS `productNameKo`,
               `product_name_en`    AS `productNameEn`,
               `model_number`       AS `modelNumber`,
               `release_date`       AS `releaseDate`,
               `color`              AS `color`,
               `brand`              AS `brand`,
               `category`           AS `category`,
               `gender`             AS `gender`,
               `created_at`         AS `createdAt`,
               `updated_at`         AS `updatedAt`,
               `is_deleted`         AS `isDeleted`
        FROM `kream`.`product`
        WHERE `id` = #{id}
        LIMIT 1
    </select>

    <select id="selectProductBySearch">
        SELECT `id`                 AS `id`,
               `category_detail_id` AS `categoryDetailId`,
               `product_name_ko`    AS `productNameKo`,
               `product_name_en`    AS `productNameEn`,
               `model_number`       AS `modelNumber`,
               `release_date`       AS `releaseDate`,
               `color`              AS `color`,
               `brand`              AS `brand`,
               `category`           AS `category`,
               `gender`             AS `gender`,
               `created_at`         AS `createdAt`,
               `updated_at`         AS `updatedAt`,
               `is_deleted`         AS `isDeleted`
        FROM `kream`.`product`
        WHERE `is_deleted` = FALSE
        <if test="filter.equals('all')"> <!-- 참일떄만 붙여준다. -->
            AND (`model_number` LIKE CONCAT('%', #{keyword}, '%') OR `product_name_ko` LIKE CONCAT('%', #{keyword}, '%') OR `product_name_en` LIKE CONCAT('%', #{keyword}, '%') OR `brand` LIKE CONCAT('%', #{keyword}, '%') OR `category` LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="filter.equals('modelNum')">
            AND `model_number` LIKE CONCAT('%', #{keyword}, '%')
        </if>
        <if test="filter.equals('name')">
            AND (`product_name_ko` LIKE CONCAT('%', #{keyword}, '%') OR `product_name_en` LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="filter.equals('brand')">
            AND `brand` LIKE CONCAT('%', #{keyword}, '%')
        </if>
        <if test="filter.equals('category')">
            AND `category` LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY `id` DESC
    </select>

    <update id="updateProduct">
        UPDATE `kream`.`product`
        SET `category_detail_id` = #{product.categoryDetailId},
            `product_name_ko`    = #{product.productNameKo},
            `product_name_en`    = #{product.productNameEn},
            `model_number`       = #{product.modelNumber},
            `release_date`       = #{product.releaseDate},
            `color`              = #{product.color},
            `brand`              = #{product.brand},
            `category`           = #{product.category},
            `gender`             = #{product.gender},
            `created_at`         = #{product.createdAt},
            `updated_at`         = #{product.updatedAt},
            `is_deleted`         = #{product.isDeleted}
        WHERE `id` = #{product.id}
        LIMIT 1
    </update>

</mapper>